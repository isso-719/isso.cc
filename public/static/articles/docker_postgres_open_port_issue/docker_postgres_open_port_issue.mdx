---
title: Docker ãŒä¿ºã® Postgres ã‚’å‹æ‰‹ã«å…¨ä¸–ç•Œã«å…¬é–‹ã—ã‚„ãŒã£ã¦è‰²ã€…æ€’ã‚‰ã‚ŒãŸè©±
date: 2024-01-28
tags: Docker, PostgreSQL, iptables, yarakashi, AdventCalendar2023
summary: Docker ãŒä¿ºã® Postgres ã‚’å‹æ‰‹ã«å…¨ä¸–ç•Œã«å…¬é–‹ã—ã‚„ãŒã£ã¦è‰²ã€…æ€’ã‚‰ã‚ŒãŸè©±ã®è¨˜äº‹ã§ã™ã€‚
author: isso
---

# æ³¨æ„!!!

ã“ã®è¨˜äº‹ã¯æ˜”ã® [Qiitaè¨˜äº‹](https://qiita.com/isso_719/items/c22e617986c821b2f624) ã®ç§»æ¤ã§ã™ã€‚
è¨˜äº‹ã®å†…å®¹ã¯2024å¹´1æœˆ9æ—¥æ™‚ç‚¹ã®ã‚‚ã®ã§ã€ç¾åœ¨ã¯å¤ã„æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

---

ã“ã¡ã‚‰ã¯ ã€Œ[æœ¬ç•ªç’°å¢ƒãªã©ã§ã‚„ã‚‰ã‹ã—ã¡ã‚ƒã£ãŸäºº Advent Calendar 2023](https://qiita.com/advent-calendar/2023/yarakashi)ã€ 22 æ—¥ç›®ã®è¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚

# ã¯ã˜ã‚ã«
Happy Coding!ğŸ¤¶
ã¿ãªã•ã‚“å¹´æœ«ã„ã‹ãŒãŠéã”ã—ã§ã—ã‚‡ã†ã‹ã€‚
ç§ã¯å’è«–ã®æŠ„éŒ²åŸ·ç­†ãŒçµ‚ã‚ã‚‰ãªã„ã—ã€ä»Šå¹´ä½“èª¿å´©ã—ã¾ãã£ã¦ã‚‹ã—ã§æ³£ããã†ã§ã™ğŸ˜­

ã“ã®è¨˜äº‹ã§ã¯æ˜”ã€…ã‚ã‚‹ã¨ã“ã‚ã§èµ·ã“ã£ãŸã€ŒDocker ãŒä¿ºã® Postgres ã‚’å‹æ‰‹ã«å…¨ä¸–ç•Œã«å…¬é–‹ã—ã‚„ãŒã£ã¦è‰²ã€…æ€’ã‚‰ã‚ŒãŸè©±ã€ã«ã¤ã„ã¦è¿°ã¹ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

â€»æ‰€å±å›£ä½“ã®é–¢ä¿‚ã§ã€**æŠ€è¡“çš„ãªè©±ä»¥å¤–ã®ã¨ã“ã‚**ã®ä¸€éƒ¨ã§è©³ã—ãè©±ã›ãªã„ã¨ã“ã‚ã¯ã¼ã‹ã—ãŸã‚Šã€ãƒ‡ã‚¿ãƒ©ãƒ¡ãªã“ã¨ã§ç½®ãæ›ãˆãŸã‚Šã—ã¦ã„ã¾ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚

# ç°¡å˜ãªè‡ªå·±ç´¹ä»‹

ç§ã¯å¤§å­¦ 4 å¹´ã§ã€åƒã„ã¦ã„ã‚‹ã¨ã„ã†è¨³ã§ã‚‚ãªãã€
å€‹äººã‚„ã¡ã‚‡ã£ã¨ã—ãŸå›£ä½“ã§ Web ã‚¢ãƒ—ãƒªã‚„ API ã‚µãƒ¼ãƒãªã©ã‚’ä½œã£ã¦ã€ã¿ã‚“ãªãŒä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

# èƒŒæ™¯

ä»Šå›ã¯æ•°å¹´å‰ã«èµ·ã“ã£ãŸã€ã¨ã‚ã‚‹å›£ä½“ã§ã®ãŠè©±ã§ã™ã€‚

:::note info
ã“ã¡ã‚‰ã®è¨˜äº‹ã¯æ•°å¹´å‰ã«èµ·ã“ã£ãŸã“ã¨ã‚’é¡Œæã«ã—ã¦ã„ã¾ã™ã€‚(ã“ã“é‡è¦)
:::

## ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆ

ãã“ã§ã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã«è¿‘ã„ç’°å¢ƒã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã®ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™ã€‚
(å°ã•ã‚ã®å€‹äººé–‹ç™ºã¨ã‹ã ã¨ã‚ˆãã‚ã‚‹æ§‹æˆã ã¨æ€ã„ã¾ã™)
- RHEL ç³» OS (ä»Šã¯ 9.x)
- Nginx Proxy ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚­ã‚·ã‚’çµ„ã‚“ã§ã„ã‚‹
- 443/tcp  -> 3000/tcp ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒã«
- 8443/tcp -> 8080/tcp ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒã«
- Docker ã«ã‚ˆã£ã¦ 3 ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒç«‹ã¡ä¸Šã’ã‚‰ã‚Œã¦ã„ã‚‹
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ (3000/tcp -> 3000/tcp)
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ  (8080/tcp -> 8080/tcp)
- PostgreSQL     (5432/tcp -> 5432/tcp)

![ã‚¢ã‚»ãƒƒãƒˆ 3.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/246409/d8d1d1a5-ee5c-f153-b330-8280cadfa7da.png)

## ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«

ã‚‚ã¡ã‚ã‚“å¤–éƒ¨å…¬é–‹ã™ã‚‹ã‚µãƒ¼ãƒãªã®ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚‚ã—ã£ã‹ã‚Šã¨ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
ç§ã¯ Linux ã«æ­è¼‰ã•ã‚ŒãŸãƒ‘ã‚±ãƒƒãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‹ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«æ©Ÿèƒ½ iptables ã‚’ç”¨ã„ã¦ã€22/tcp, 443/tcp, 8443/tcp ä»¥å¤–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ãªã„ã‚ˆã†ãªè¨­å®šã‚’ã—ã¦ã„ã¾ã—ãŸã€‚

```iptables:/etc/sysconfig/iptables
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:SUBNET - [0:0]

# lo
-A INPUT -i lo -j ACCEPT

# Drops
-A INPUT -p tcp --tcp-flags ALL NONE -j DROP
-A INPUT -p tcp ! --syn -m state --state NEW -j DROP
-A INPUT -p tcp --tcp-flags ALL ALL -j DROP

# Accept Rules
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 8443 -j ACCEPT
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

-A INPUT -j REJECT --reject-with icmp-host-prohibited

COMMIT
```

# å•é¡Œç™ºè¦š

ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‹•ã‹ã—ã¦ã—ã°ã‚‰ãã—ãŸå¾Œã€å›£ä½“ã®ã‚µãƒ¼ãƒç¾¤ã‚’è„†å¼±æ€§è¨ºæ–­ã«ã‹ã‘ãŸã£ã½ã„ã§ã™ã€‚
ãã®çµæœ...
```plaintext:è„†å¼±æ€§è¨ºæ–­çµæœ (ã‚µãƒ³ãƒ—ãƒ«)
ãƒ›ã‚¹ãƒˆè¨ºæ–­çµæœ: ãƒ¬ãƒ™ãƒ« High, æ—©æ€¥ã«å¯¾å¿œãŒå¿…è¦ã§ã™

å†…å®¹:
PostgreSQL ã«ç·å½“ãŸã‚Šæ”»æ’ƒã‚’ä»•æ›ã‘ã‚‹ã“ã¨ã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå¯èƒ½ã€‚
æ”»æ’ƒè€…ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãæ›ãˆã‚‰ã‚ŒãŸã‚Šã€OS ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã•ã‚Œã‚‹å±é™ºæ€§ã‚ã‚Šã€‚
ãƒ¦ãƒ¼ã‚¶å: postgres
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: hogehoge

å¯¾ç­–:
å¿…è¦æœ€ä½é™ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«åˆ¶é™ã—ã¦ãã ã•ã„ã€‚
```

ã‚ªãƒ¯ã‚¿ğŸ˜‡ (èªè¨¼æƒ…å ±ã¾ã§å½“ã¦ã¦ãã‚‹ã‚“ã‚„ã€ã™ã”ã„...)
ã£ã¦ã“ã¨ã§ã€ã™ã”ãæ€’ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸ...ã€‚

ã“ã‚ŒãŒãƒ¡ãƒ¼ãƒ«ã§è»¢é€ã•ã‚Œã¦ããŸæ™‚ã€ã™ã”ãé¡”ãŒé’ã–ã‚ãŸã“ã¨ã‚’ä»Šã§ã‚‚æ€ã„å‡ºã—ã¾ã™...ã€‚

# åŸå› 

åŸå› ã¯ 2 ã¤è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

## ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç°¡å˜ãªã‚‚ã®ã«ãªã£ã¦ã„ãŸ

ã“ã‚Œã¯æœ¬å½“ã«ç§ãŒæ‚ªã„ã§ã™ã€‚
æŒ¯ã‚Šè¿”ã‚‹ã¨çŸ­ã‚ã§æ¨æ¸¬ã•ã‚Œã‚„ã™ã„ã‚‚ã®ã«ãªã£ã¦ã„ãŸã‹ã‚‰ã§ã™ã€‚
ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶åã‚‚ `postgres` ã«ãªã£ã¦ã„ã¾ã—ãŸ...ã€‚

ã“ã®å‡ºæ¥äº‹ã‹ã‚‰ã€Postgres ã®ãƒ¦ãƒ¼ã‚¶ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åãªã©ã¯ã€
ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã—ã€
ä¿¡é ¼ã§ãã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ãŠã„ã¦ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```zsh
% openssl rand -base64 12
NjkuJWWwf9MmN5j4
```

## ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®šãŒå¤‰ã‚ã£ã¦ãŸ? [æœ¬å‘½]

å•é¡Œã¯ã“ã“ã§ã™ã€‚
ç¢ºã‹ã« iptables ã§ã¯ 22/tcp, 443/tcp, 8443/tcp ãƒãƒ¼ãƒˆã—ã‹ç©ºã„ã¦ã„ãªã‹ã£ãŸã¯ãšã€‚
Postgres ã®ãƒãƒ¼ãƒˆã¯ 5432/tcp ã§ iptables ã®è¨­å®šã‚’è¦‹ã¦ã‚‚é–‹ã„ã¦ã„ã‚‹ã‚ˆã†ãªæ„Ÿã˜ã¯ã—ã¾ã›ã‚“ã§ã—ãŸã€‚

# Docker ã¨ iptables

åŸå› ã¯ Docker ã§ã—ãŸã€‚

[Docker ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.jp/network/iptables.html)ã‚’è¦‹ã‚‹ã¨ã¨ã‚“ã§ã‚‚ãªã„ã“ã¨ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚

```
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€å…¨ã¦ã®å¤–éƒ¨ã‚½ãƒ¼ã‚¹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ Docker ãƒ›ã‚¹ãƒˆã«æ¥ç¶šã§ãã¾ã™ã€‚
```

ãªã€ãªã‚“ã ã¨ã£ ï¼ï¼ï¼ï¼ï¼

ãªã‚“ã¨ **Docker ãŒä¿ºã® Postgres ã‚’å‹æ‰‹ã«å…¨ä¸–ç•Œã«å…¬é–‹ã—ã‚„ãŒã£ã¦ã„ãŸ**ã‚‰ã—ã„ã§ã™ã€‚

ãã‚Œã ã‘ã§ãªãã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒã‚‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒã‚‚ã€
å…¨ã¦ãƒ—ãƒ­ã‚­ã‚·ã‚’é€šã˜ãšã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

æ‰‹å…ƒã®ç’°å¢ƒã§è©¦ã—ãŸã‚‰ã€
ç¢ºã‹ã« Docker ã®ãƒ‡ãƒ¼ãƒ¢ãƒ³èµ·å‹•å‰ã¨èµ·å‹•å¾Œã§ iptables ã®è¨­å®šãŒå¤§ããå¤‰ã‚ã£ã¦ãŠã‚Šã€
Docker ã§å»ºã¦ãŸã‚³ãƒ³ãƒ†ãƒŠãŒå…¨ã¦å¤–éƒ¨ã‹ã‚‰é–²è¦§ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

- Docker Daemon èµ·å‹•å‰
  ```bash:Docker Daemon èµ·å‹•å‰ã® iptables ã®è¨­å®š
  # iptables -L
  Chain INPUT (policy DROP)
  target     prot opt source               destination
  ACCEPT     all  --  anywhere             anywhere
  DROP       tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,PSH,ACK,URG/NONE
  DROP       tcp  --  anywhere             anywhere             tcp flags:!FIN,SYN,RST,ACK/SYN state NEW
  DROP       tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,PSH,ACK,URG/FIN,SYN,RST,PSH,ACK,URG
  ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
  ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https
  ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:pcsync-https
  ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
  REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

  Chain FORWARD (policy DROP)
  target     prot opt source               destination

  Chain OUTPUT (policy ACCEPT)
  target     prot opt source               destination

  Chain SUBNET (0 references)
  target     prot opt source               destination
    ```

- Docker Daemon èµ·å‹•å¾Œ
  ```bash:Docker Daemon èµ·å‹•å¾Œã® iptables ã®è¨­å®š
  # systemctl start docker
  # iptables -L
  Chain INPUT (policy DROP)
  target     prot opt source               destination
  ACCEPT     all  --  anywhere             anywhere
  DROP       tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,PSH,ACK,URG/NONE
  DROP       tcp  --  anywhere             anywhere             tcp flags:!FIN,SYN,RST,ACK/SYN state NEW
  DROP       tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,PSH,ACK,URG/FIN,SYN,RST,PSH,ACK,URG
  ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
  ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https
  ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:pcsync-https
  ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
  REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

  Chain FORWARD (policy DROP)
  target     prot opt source               destination
  DOCKER-USER  all  --  anywhere             anywhere
  DOCKER-ISOLATION-STAGE-1  all  --  anywhere             anywhere
  ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
  DOCKER     all  --  anywhere             anywhere
  ACCEPT     all  --  anywhere             anywhere
  ACCEPT     all  --  anywhere             anywhere
  ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
  DOCKER     all  --  anywhere             anywhere
  ACCEPT     all  --  anywhere             anywhere
  ACCEPT     all  --  anywhere             anywhere

  Chain OUTPUT (policy ACCEPT)
  target     prot opt source               destination

  Chain DOCKER (2 references)
  target     prot opt source               destination

  Chain DOCKER-ISOLATION-STAGE-1 (1 references)
  target     prot opt source               destination
  DOCKER-ISOLATION-STAGE-2  all  --  anywhere             anywhere
  DOCKER-ISOLATION-STAGE-2  all  --  anywhere             anywhere
  RETURN     all  --  anywhere             anywhere

  Chain DOCKER-ISOLATION-STAGE-2 (2 references)
  target     prot opt source               destination
  DROP       all  --  anywhere             anywhere
  DROP       all  --  anywhere             anywhere
  RETURN     all  --  anywhere             anywhere

  Chain DOCKER-USER (1 references)
  target     prot opt source               destination
  RETURN     all  --  anywhere             anywhere

  Chain SUBNET (0 references)
  target     prot opt source               destination
    ```

- ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³ (ã‚¤ãƒ¡ãƒ¼ã‚¸)
  ```bash:ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³çµæœ (ã‚¤ãƒ¡ãƒ¼ã‚¸)
  % nmap hogehoge.example.com
  â€¦
  PORT     STATE    SERVICE
  22/tcp   open     ssh
  443/tcp  open     https
  3000/tcp open     front
  5432/tcp open     postgresql
  8080/tcp open     api
  8443/tcp open     http-proxy
  â€¦
    ```

ã“ã‚“ãªè½ã¨ã—ç©´ãŒã‚ã‚‹ãªã‚“ã¦...ã¨ã»ã»...ğŸ¥º

**ã“ã®ç¾è±¡ã¯ ufw ãªã©ä»–ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§ã‚‚ç™ºç”Ÿã™ã‚‹ãã†ã§ã™ã€‚**
(iptables ã˜ã‚ƒãªã„ã‹ã‚‰ã£ã¦å®‰å¿ƒã—ã¦ã‚‹ãã“ã®ã‚ãªãŸã‚‚æ³¨æ„ï¼)

https://tec.tecotec.co.jp/entry/2021/12/17/000000

# å•é¡Œã®è§£æ±º

[Docker ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.jp/network/iptables.html)ã‚’è¦‹ã‚‹ã¨ã€ã“ã®ã‚ˆã†ãªã“ã¨ã‚‚æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚

```
ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦ç‰¹å®šã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ã—ãã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ã¿è¨±å¯ã™ã‚‹ã«ã¯ã€
DOCKER-USER ãƒ•ã‚£ãƒ«ã‚¿ ãƒã‚§ã‚¤ãƒ³ã®ä¸€ç•ªä¸Šã«
ç„¡åŠ¹åŒ–ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ãŸã¨ãˆã°ã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã¯ 192.168.1.1 ã‚’é™¤ãå…¨ã¦ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¾ã™ã€‚

$ iptables -I DOCKER-USER -i ext_if ! -s 192.168.1.1 -j DROP
```

ã©ã†ã‚„ã‚‰ iptables ã®è¨­å®šã« DOCKER-USER ãƒ•ã‚£ãƒ«ã‚¿ãƒã‚§ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚Œã°è§£æ±ºã—ãã†ã§ã™ã€‚
Docker ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚¯ãƒ©ã‚¹ B (172.16.0.0/12) ã®ä¸­ã§ IP ã‚’å‰²ã‚ŠæŒ¯ã‚‹ãŸã‚ã€
å¤–ã‹ã‚‰ã¯ 172.16.0.0/12 ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã€
ãã‚Œä»¥å¤–ã¯è¨±å¯ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

```iptables:/etc/sysconfig/iptables
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:SUBNET - [0:0]

# DOCKER-USER Filter ã‚’è¿½åŠ 
:DOCKER-USER - [0:0]

# lo
-A INPUT -i lo -j ACCEPT

# Drops
-A INPUT -p tcp --tcp-flags ALL NONE -j DROP
-A INPUT -p tcp ! --syn -m state --state NEW -j DROP
-A INPUT -p tcp --tcp-flags ALL ALL -j DROP

# Accept Rules
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 8443 -j ACCEPT
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

-A INPUT -j REJECT --reject-with icmp-host-prohibited

#
# ã“ã“ã‹ã‚‰ DOCKER-USER Chain è¨­å®š
#
-A DOCKER-USER -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A DOCKER-USER -s 172.16.0.0/12 -j ACCEPT
-A DOCKER-USER -j REJECT

COMMIT
```

è¨­å®šã‚’ç¢ºèªã™ã‚‹ã¨ã€
`Docker Daemon èµ·å‹•å¾Œã® iptables ã®è¨­å®š` ã¨æ¯”è¼ƒã—ã¦ã€
è¨­å®šã§ãã¦ã„ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¾ã™ã€‚

```bash:DOCKER-USER Filter Chain è¿½åŠ å¾Œã® iptables ã®è¨­å®š
Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere
DROP       tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,PSH,ACK,URG/NONE
DROP       tcp  --  anywhere             anywhere             tcp flags:!FIN,SYN,RST,ACK/SYN state NEW
DROP       tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,PSH,ACK,URG/FIN,SYN,RST,PSH,ACK,URG
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:pcsync-https
ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

Chain FORWARD (policy DROP)
target     prot opt source               destination
DOCKER-USER  all  --  anywhere             anywhere
DOCKER-ISOLATION-STAGE-1  all  --  anywhere             anywhere
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
DOCKER     all  --  anywhere             anywhere
ACCEPT     all  --  anywhere             anywhere
ACCEPT     all  --  anywhere             anywhere
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
DOCKER     all  --  anywhere             anywhere
ACCEPT     all  --  anywhere             anywhere
ACCEPT     all  --  anywhere             anywhere

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

Chain DOCKER (2 references)
target     prot opt source               destination

Chain DOCKER-ISOLATION-STAGE-1 (1 references)
target     prot opt source               destination
DOCKER-ISOLATION-STAGE-2  all  --  anywhere             anywhere
DOCKER-ISOLATION-STAGE-2  all  --  anywhere             anywhere
RETURN     all  --  anywhere             anywhere

Chain DOCKER-ISOLATION-STAGE-2 (2 references)
target     prot opt source               destination
DROP       all  --  anywhere             anywhere
DROP       all  --  anywhere             anywhere
RETURN     all  --  anywhere             anywhere

Chain DOCKER-USER (1 references)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
ACCEPT     all  --  172.16.0.0/12        anywhere
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable
RETURN     all  --  anywhere             anywhere

Chain SUBNET (0 references)
target     prot opt source               destination
```

å¤–éƒ¨ã‹ã‚‰ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³ã‚’ã™ã‚‹ã¨ã€22/tcp, 443/tcp, 8443/tcp ä»¥å¤–ã¯è¦‹ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼

```bash:ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³çµæœ (ã‚¤ãƒ¡ãƒ¼ã‚¸)
% nmap hogehoge.example.com
â€¦
PORT     STATE    SERVICE
22/tcp   open     ssh
443/tcp  open     https
8443/tcp open     http-proxy
â€¦
```

# ã¾ã¨ã‚

ä»Šå›ã¯ Docker ã«ã‚ˆã£ã¦ iptables ã®è¨­å®šãŒå‹æ‰‹ã«å¤‰ãˆã‚‰ã‚Œã€
éš ã™ã¹ã Postgres ãŒå…¬é–‹ã•ã‚Œã¦ã—ã¾ã£ãŸè©±ã‚’è¿°ã¹ã¦ãã¾ã—ãŸï¼

Docker ã«ã‚ˆã£ã¦ iptables ã‚„ ufw ã«ç©´ã‚’é–‹ã‘ã‚‰ã‚Œã‚‹è©±ã¯ã€
èª¿ã¹ãŸæ„Ÿã˜ã‹ãªã‚Šæœ‰åãªè©±ã£ã½ã„ã§ã™ãŒã€
**åƒ•ã¨åŒã˜ã“ã¨ã‚’ã‚„ã‚‰ã‹ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹äººã¯å¤šã„**ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

å…¬é–‹ã‚µãƒ¼ãƒã§ Docker ã‚’å‹•ã‹ã—ã¦ã„ã‚‹äººã¯ã€
ä»Šä¸€åº¦ iptables ã®è¨­å®šã‚’è¦‹ç›´ã™ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

ä»¥ä¸Šã€è‰¯ã„ãŠå¹´ã‚’...ğŸ…
